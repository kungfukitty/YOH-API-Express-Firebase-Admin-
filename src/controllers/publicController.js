import { getAdmin } from '../config/firebase.js';export async function verifyCode(req,res){const { code,email }=req.body||{};if(!code) return res.status(400).json({error:'code required'});const db=getAdmin().firestore();const ref=db.collection('access_codes').doc(code);const snap=await ref.get();if(!snap.exists) return res.status(404).json({error:'Invalid code'});const data=snap.data();if(data.expiresAt && data.expiresAt.toDate && data.expiresAt.toDate()<new Date()) return res.status(400).json({error:'Code expired'});if(data.usesRemaining!==undefined && data.usesRemaining<=0) return res.status(400).json({error:'Code exhausted'});return res.json({valid:true,ndaRequired:true,ndaVersion:'2025-10-01',codeId:code})}export async function acceptNDA(req,res){const { codeId,ndaVersion,email }=req.body||{};if(!codeId||!ndaVersion) return res.status(400).json({error:'missing fields'});const admin=getAdmin();const db=admin.firestore();const batch=db.batch();const codeRef=db.collection('access_codes').doc(codeId);const codeSnap=await codeRef.get();if(!codeSnap.exists) return res.status(404).json({error:'Invalid code'});const acceptRef=db.collection('nda_acceptances').doc();batch.set(acceptRef,{email:email||null,codeId,ndaVersion,acceptedAt:admin.firestore.FieldValue.serverTimestamp()});if(codeSnap.data().usesRemaining!==undefined){batch.update(codeRef,{usesRemaining:Math.max(0,(codeSnap.data().usesRemaining||1)-1)})}await batch.commit();return res.json({ok:true})}